<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>midem test demo </title>
  </head>
  <body>
    <script type="module">
      import init, {execute_zk_program, generate_program_hash, init_panic_hook} from "./pkg/miden_vm.js";
       async function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
}

      init().then( m => {
        let t1 = new Date() 
        init_panic_hook()

        let program2 = `
        # store R at memory 100
# store MerkleTreeLayerDepth at memory 101
# store MerkleTreeRoot at memory 102
# store AddressHash at memory 103
# store Nullifier at memory 104
# store Value at memory 105
# store CheckingResult at memory 106

# advice_tape: [hash_time, (Path1, flag), (Path2, flag)....]
proc.compute_note_root
  # Push the hash times flag into the stack
  adv_push.1 
  
  dup.0 push.0 eq
  if.true
    drop
  else
    movdn.4 push.1 

    # Compute the Roothash according to the MerklePath & flags
    while.true
      adv_push.4 adv_push.1 
      if.true
          hmerge
      else 
          swapw  hmerge
      end
      movup.4 sub.1 dup.0 movdn.5 push.0 gt 
    end
  end

end

# advice_tape: [random, pay_value]  (mem_load.100, mem_load.105)
proc.compute_note_leave
  mem_load.100 push.0.0.0 push.0.0.0.0 hmerge
  movup.3 mem_load.105 add movdn.3
  push.0.0.0.0 hmerge
end

# advice_tape: [random] (mem_load.100)
proc.compute_leave_nullfier
  mem_load.100 add.1 push.0.0.0 push.0.0.0.0 hmerge
end

# store R at memory 100
# store MerkleTreeLayerDepth at memory 101
# store MerkleTreeRoot at memory 102
# store AddressHash at memory 103
# store Nullifier at memory 104
# store Value at memory 105
# store CheckingResult at memory 106

# publicInput：Value、Nullifier、AddressHash、MerkleRoot
# secretInput：R、【MerkleTreeLayerDepth】、MerklePath
begin
    # Init mem_storage
    mem_storew.102 dropw mem_storew.103 dropw
    mem_storew.104 dropw mem_store.105
    adv_push.1 mem_store.100
    
    # Generate Nullfier and check
    exec.compute_leave_nullfier
    push.0.0.0.0 mem_loadw.104 eqw mem_store.106 dropw dropw
     
    # Compute note leave hash : HRP: hash(R_hash + v)
    exec.compute_note_leave
    
    # Verify MerkleTreePath and check
    exec.compute_note_root
    push.0.0.0.0 mem_loadw.102 eqw mem_load.106 and mem_store.106 dropw dropw
    
    
    
    # mix the address with value
    push.0.0.0.0
    mem_loadw.103 mem_load.105 push.0.0.0 hmerge
    mem_load.106
end

`;


        var t = new Date();
        // the first array is public input, the sec is secret input
        // let output = execute_zk_program(program, "","6833784672397792804,1738843643968560814,14461430620336761827,12110009229538442525,19,1,0,0,0,0,0,0,11163774851835570377,9362862845627922325,13487000498173000578,8882224816854508067,14575308179982110358,17433735800768262380,8768951732059513786,4790773657737358814,7542115670608157565,8444373719912261442,14347248385715939903,2960226829132908104,129,156,1,0,0,0,0,0,7077620387898955118,679287600474868924,15132917276352316628,3931973049508962096,5107192246664894678,2229368643187067388,9712480462957145443,1739771992166299667,7060296349883902801,4165408376239840973,2516309578450629202,5759828452952020339")
        let output = execute_zk_program(
            program2,
            "100,12858789631008694095,11553966295695754492,16108046478584009545,6369861335950478001,16987025927072847600,17865979427513675588,1239151424,0,16164951951126600518,14880047730447912276,10842350795377780652,13301946846699042177",
            "45807,1,12532255349883653886,8234216457885637245,5325328945780445243,4233516980739651124,0"
                )

        var tt = new Date();
        console.log(output)

        console.log(tt.getTime() - t.getTime())
        let program_hash = generate_program_hash(program2)

        console.log(program_hash)

        // console.log(verify_zk_bool(program_hash, "", output))        
              }).catch(console.error);
      </script>
  </body>
</html>